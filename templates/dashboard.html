<!DOCTYPE html>
<html>
<head>
    <title>Painel de Controle - Bot de Inatividade</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            font-weight: bold;
            background-color: #2c3e50;
            color: white;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-operational {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .guild-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        .config-input {
            max-width: 100px;
        }
        .queue-status {
            font-family: monospace;
        }
        .log-entry {
            font-family: monospace;
            font-size: 0.85rem;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
            background-color: #f8f9fa;
            white-space: pre-wrap;
        }
        .log-error {
            color: #dc3545;
            background-color: #f8d7da;
        }
        .log-warning {
            color: #856404;
            background-color: #fff3cd;
        }
        .log-info {
            color: #0c5460;
            background-color: #d1ecf1;
        }
        .event-item {
            border-left: 4px solid #0d6efd;
            padding-left: 10px;
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #0d6efd;
        }
        .whitelist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .badge-queue {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .loading-spinner {
            display: none;
            width: 1.5rem;
            height: 1.5rem;
        }
        .btn-action {
            min-width: 100px;
        }
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Container de Toast para notificações -->
    <div id="toast-container"></div>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1><i class="bi bi-robot"></i> Painel de Controle</h1>
                <p class="text-muted">Monitoramento do Bot de Inatividade</p>
            </div>
        </div>
        
        <div class="row">
            <!-- Status Geral -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> Status do Bot
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="bot-name">Carregando...</h5>
                        <div class="mb-3">
                            <span class="status-indicator status-operational" id="bot-status-icon"></span>
                            <span id="bot-status-text">Verificando...</span>
                        </div>
                        <p class="card-text"><i class="bi bi-discord"></i> Servidores: <span id="guild-count">0</span></p>
                        <p class="card-text"><i class="bi bi-clock"></i> Uptime: <span id="uptime">N/A</span></p>
                        <p class="card-text"><i class="bi bi-database"></i> Banco de Dados: 
                            <span class="badge" id="db-status-badge">Verificando...</span>
                        </p>
                        <div class="mb-3">
                            <h6>Status das Filas:</h6>
                            <div id="queue-status">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                        <a href="/monitor" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-graph-up"></i> Ver Monitoramento
                        </a>
                    </div>
                </div>
                
                <!-- Whitelist -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-shield-check"></i> Whitelist
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>Usuários na Whitelist:</h6>
                            <div id="whitelist-users">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="whitelist-user-id" placeholder="ID do Usuário">
                                <button class="btn btn-success" id="add-user-whitelist">
                                    <span class="spinner-border spinner-border-sm loading-spinner" id="add-user-spinner"></span>
                                    <i class="bi bi-plus" id="add-user-icon"></i>
                                </button>
                            </div>
                            <div class="form-text">Insira o ID do usuário e clique em +</div>
                        </div>
                        <div class="mb-3">
                            <h6>Cargos na Whitelist:</h6>
                            <div id="whitelist-roles">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="whitelist-role-id" placeholder="ID do Cargo">
                                <button class="btn btn-success" id="add-role-whitelist">
                                    <span class="spinner-border spinner-border-sm loading-spinner" id="add-role-spinner"></span>
                                    <i class="bi bi-plus" id="add-role-icon"></i>
                                </button>
                            </div>
                            <div class="form-text">Insira o ID do cargo e clique em +</div>
                        </div>
                    </div>
                </div>

                <!-- Status das Tarefas -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-task"></i> Tarefas Ativas
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" id="active-tasks">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Processador de Eventos
                                <span class="badge bg-success rounded-pill" id="event-processor-status">Ativo</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Processador de Mensagens
                                <span class="badge bg-success rounded-pill" id="message-processor-status">Ativo</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Verificação de Áudio
                                <span class="badge bg-success rounded-pill" id="audio-check-status">Ativo</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Monitor de Saúde
                                <span class="badge bg-success rounded-pill" id="health-check-status">Ativo</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Servidores -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-collection"></i> Servidores
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Nome</th>
                                        <th>Membros</th>
                                        <th>Canais de Voz</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="guilds-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos e Eventos -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="analyticsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">Atividade</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab">Eventos</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">Logs</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="analyticsTabContent">
                            <div class="tab-pane fade show active" id="activity" role="tabpanel">
                                <div class="chart-container">
                                    <canvas id="activityChart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <canvas id="usageChart"></canvas>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="events" role="tabpanel">
                                <div id="recentEvents">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="logs" role="tabpanel">
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button class="btn btn-sm btn-primary" id="refreshLogs">
                                                <span class="spinner-border spinner-border-sm loading-spinner" id="refresh-logs-spinner"></span>
                                                <i class="bi bi-arrow-clockwise" id="refresh-logs-icon"></i> Atualizar Logs
                                            </button>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <div class="input-group input-group-sm" style="width: 200px;">
                                                <input type="number" class="form-control" id="log-lines-count" value="100" min="10" max="1000">
                                                <span class="input-group-text">linhas</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="logEntries" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configurações -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> Configurações
                    </div>
                    <div class="card-body">
                        <div id="config-form">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="required_minutes" class="form-label">Minutos necessários em voz:</label>
                                        <input type="number" class="form-control config-input" id="required_minutes">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="required_days" class="form-label">Dias diferentes necessários:</label>
                                        <input type="number" class="form-control config-input" id="required_days">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="monitoring_period" class="form-label">Período de monitoramento (dias):</label>
                                        <input type="number" class="form-control config-input" id="monitoring_period">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="kick_after_days" class="form-label">Expulsar após dias sem cargo:</label>
                                        <input type="number" class="form-control config-input" id="kick_after_days">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="notification_channel" class="form-label">Canal de Notificação:</label>
                                        <input type="text" class="form-control" id="notification_channel" placeholder="ID do Canal">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="log_channel" class="form-label">Canal de Log:</label>
                                        <input type="text" class="form-control" id="log_channel" placeholder="ID do Canal">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="absence_channel" class="form-label">Canal de Ausência:</label>
                                        <input type="text" class="form-control" id="absence_channel" placeholder="ID do Canal">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="timezone" class="form-label">Fuso Horário:</label>
                                        <select class="form-select" id="timezone">
                                            <option value="America/Sao_Paulo">America/Sao_Paulo</option>
                                            <option value="UTC">UTC</option>
                                            <option value="America/New_York">America/New_York</option>
                                            <option value="Europe/London">Europe/London</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button id="save-config" class="btn btn-primary btn-action">
                                <span class="spinner-border spinner-border-sm loading-spinner" id="save-config-spinner"></span>
                                <i class="bi bi-save" id="save-config-icon"></i> Salvar Configurações
                            </button>
                            <button id="restart-bot" class="btn btn-warning ms-2 btn-action">
                                <i class="bi bi-arrow-repeat"></i> Reiniciar Bot
                            </button>
                            <button id="backup-bot" class="btn btn-secondary ms-2 btn-action">
                                <span class="spinner-border spinner-border-sm loading-spinner" id="backup-spinner"></span>
                                <i class="bi bi-download" id="backup-icon"></i> Criar Backup
                            </button>
                            <button id="export-report" class="btn btn-info ms-2 btn-action">
                                <i class="bi bi-file-earmark-text"></i> Exportar Relatório
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detalhes da Guilda (modal) -->
        <div class="modal fade" id="guildModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="guildModalTitle">Detalhes do Servidor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="guildModalBody">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais para os gráficos
        let activityChart, usageChart;
        let refreshIntervals = [];
        
        // Função para mostrar toast (notificação)
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            
            const typeClasses = {
                'success': 'bg-success text-white',
                'error': 'bg-danger text-white',
                'warning': 'bg-warning text-dark',
                'info': 'bg-info text-white'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast show ${typeClasses[type] || ''}`;
            toast.id = toastId;
            toast.role = 'alert';
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.style.marginBottom = '10px';
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remover o toast após 5 segundos
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.style.opacity = '0';
                    setTimeout(() => toastElement.remove(), 300);
                }
            }, 5000);
        }

        // Função para alternar o estado de carregamento de um botão
        function toggleLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            const spinner = button.querySelector('.loading-spinner');
            const icon = button.querySelector('i');
            
            if (isLoading) {
                spinner.style.display = 'inline-block';
                if (icon) icon.style.display = 'none';
                button.disabled = true;
            } else {
                spinner.style.display = 'none';
                if (icon) icon.style.display = 'inline-block';
                button.disabled = false;
            }
        }

        // Carregar configurações atuais
        async function loadConfig() {
            try {
                const response = await fetch('/api/guilds');
                if (!response.ok) throw new Error('Erro ao carregar guildas');
                
                const guilds = await response.json();
                if (guilds.length > 0) {
                    const guildResponse = await fetch(`/api/guild/${guilds[0].id}`);
                    if (!guildResponse.ok) throw new Error('Erro ao carregar configurações');
                    
                    const config = await guildResponse.json();
                    
                    document.getElementById('required_minutes').value = config.config.required_minutes;
                    document.getElementById('required_days').value = config.config.required_days;
                    document.getElementById('monitoring_period').value = config.config.monitoring_period;
                    document.getElementById('kick_after_days').value = config.config.kick_after_days;
                    
                    if (config.notification_settings) {
                        document.getElementById('notification_channel').value = config.notification_settings.notification_channel || '';
                        document.getElementById('log_channel').value = config.notification_settings.log_channel || '';
                        document.getElementById('absence_channel').value = config.notification_settings.absence_channel || '';
                    }
                    
                    if (config.config.timezone) {
                        document.getElementById('timezone').value = config.config.timezone;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                showToast('Erro ao carregar configurações: ' + error.message, 'error');
            }
        }

        // Carregar lista de servidores
        async function loadGuilds() {
            try {
                const response = await fetch('/api/guilds');
                if (!response.ok) throw new Error('Erro ao carregar servidores');
                
                const guilds = await response.json();
                const tbody = document.getElementById('guilds-table-body');
                
                if (guilds.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum servidor encontrado</td></tr>';
                    return;
                }
                
                let html = '';
                guilds.forEach(guild => {
                    html += `
                        <tr>
                            <td>
                                ${guild.icon ? 
                                    `<img src="${guild.icon}" class="guild-icon" alt="${guild.name}">` : 
                                    `<i class="bi bi-server guild-icon bg-secondary text-white d-flex align-items-center justify-content-center"></i>`}
                            </td>
                            <td>${guild.name}</td>
                            <td>${guild.member_count}</td>
                            <td>${guild.voice_channels}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadGuildDetails('${guild.id}')">
                                    <i class="bi bi-eye"></i> Detalhes
                                </button>
                            </td>
                        </tr>`;
                });
                
                tbody.innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar servidores:', error);
                showToast('Erro ao carregar servidores: ' + error.message, 'error');
            }
        }

        // Carregar detalhes da guilda
        async function loadGuildDetails(guildId) {
            try {
                const modal = new bootstrap.Modal(document.getElementById('guildModal'));
                document.getElementById('guildModalTitle').textContent = 'Carregando...';
                document.getElementById('guildModalBody').innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>`;
                
                modal.show();
                
                const response = await fetch(`/api/guild/${guildId}`);
                if (!response.ok) throw new Error('Erro ao carregar detalhes');
                
                const guild = await response.json();
                
                document.getElementById('guildModalTitle').textContent = guild.name;
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Configurações</h5>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Minutos necessários
                                    <span class="badge bg-primary rounded-pill">${guild.config.required_minutes}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Dias necessários
                                    <span class="badge bg-primary rounded-pill">${guild.config.required_days}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Período de monitoramento
                                    <span class="badge bg-primary rounded-pill">${guild.config.monitoring_period} dias</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Expulsão após
                                    <span class="badge bg-primary rounded-pill">${guild.config.kick_after_days} dias</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Estatísticas</h5>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Cargos monitorados
                                    <span class="badge bg-primary rounded-pill">${guild.tracked_roles.length}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Usuários ativos
                                    <span class="badge bg-success rounded-pill">${guild.activity_stats.active_users || 0}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Usuários inativos
                                    <span class="badge bg-warning rounded-pill">${guild.activity_stats.inactive_users || 0}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Usuários avisados
                                    <span class="badge bg-danger rounded-pill">${guild.activity_stats.warned_users || 0}</span>
                                </li>
                            </ul>
                        </div>
                    </div>`;
                
                if (guild.tracked_roles.length > 0) {
                    html += `
                        <h5 class="mt-3">Cargos Monitorados</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Membros</th>
                                        <th>Cor</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    guild.tracked_roles.forEach(role => {
                        html += `
                            <tr>
                                <td>${role.name}</td>
                                <td>${role.member_count}</td>
                                <td><span class="badge" style="background-color: ${role.color}">&nbsp;&nbsp;&nbsp;</span></td>
                            </tr>`;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>`;
                }
                
                if (guild.voice_channels.length > 0) {
                    html += `
                        <h5 class="mt-3">Canais de Voz</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Usuários</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    guild.voice_channels.forEach(channel => {
                        html += `
                            <tr>
                                <td>${channel.name}</td>
                                <td>${channel.user_count}</td>
                            </tr>`;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>`;
                }
                
                document.getElementById('guildModalBody').innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar detalhes da guilda:', error);
                document.getElementById('guildModalBody').innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar detalhes do servidor: ${error.message}
                    </div>`;
            }
        }

        // Carregar whitelist
        async function loadWhitelist() {
            try {
                const response = await fetch('/api/whitelist');
                if (!response.ok) throw new Error('Erro ao carregar whitelist');
                
                const data = await response.json();
                
                // Usuários
                let usersHtml = '';
                if (data.users && data.users.length > 0) {
                    data.users.forEach(userId => {
                        usersHtml += `
                            <div class="whitelist-item">
                                <span>${userId}</span>
                                <button class="btn btn-sm btn-danger remove-whitelist" data-type="user" data-id="${userId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>`;
                    });
                } else {
                    usersHtml = '<p class="text-muted">Nenhum usuário na whitelist</p>';
                }
                document.getElementById('whitelist-users').innerHTML = usersHtml;
                
                // Cargos
                let rolesHtml = '';
                if (data.roles && data.roles.length > 0) {
                    data.roles.forEach(roleId => {
                        rolesHtml += `
                            <div class="whitelist-item">
                                <span>${roleId}</span>
                                <button class="btn btn-sm btn-danger remove-whitelist" data-type="role" data-id="${roleId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>`;
                    });
                } else {
                    rolesHtml = '<p class="text-muted">Nenhum cargo na whitelist</p>';
                }
                document.getElementById('whitelist-roles').innerHTML = rolesHtml;
                
                // Adicionar eventos aos botões de remoção
                document.querySelectorAll('.remove-whitelist').forEach(button => {
                    button.addEventListener('click', function() {
                        const type = this.getAttribute('data-type');
                        const id = this.getAttribute('data-id');
                        updateWhitelist('remove', type, id);
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar whitelist:', error);
                showToast('Erro ao carregar whitelist: ' + error.message, 'error');
            }
        }

        // Atualizar whitelist
        async function updateWhitelist(action, targetType, targetId) {
            try {
                toggleLoading(targetType === 'user' ? 'add-user-whitelist' : 'add-role-whitelist', true);
                
                const response = await fetch('/api/whitelist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        type: targetType,
                        id: targetId
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erro desconhecido');
                }
                
                await loadWhitelist();
                
                if (targetType === 'user') {
                    document.getElementById('whitelist-user-id').value = '';
                } else {
                    document.getElementById('whitelist-role-id').value = '';
                }
                
                showToast(`Whitelist atualizada com sucesso! (${action} ${targetType})`, 'success');
            } catch (error) {
                console.error('Erro ao atualizar whitelist:', error);
                showToast('Erro ao atualizar whitelist: ' + error.message, 'error');
            } finally {
                toggleLoading(targetType === 'user' ? 'add-user-whitelist' : 'add-role-whitelist', false);
            }
        }

        // Carregar eventos recentes
        async function loadRecentEvents() {
            try {
                document.getElementById('recentEvents').innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>`;
                
                const response = await fetch('/api/events');
                if (!response.ok) throw new Error('Erro ao carregar eventos');
                
                const data = await response.json();
                
                let html = '<h5>Eventos Recentes</h5>';
                
                if (data.recent_events && data.recent_events.length > 0) {
                    data.recent_events.forEach(event => {
                        html += `
                            <div class="event-item">
                                <div><strong>${event.time}</strong> - ${event.endpoint}</div>
                                <div>Bucket: ${event.bucket} - Restantes: ${event.remaining}</div>
                                <small class="text-muted">${event.method || 'GET'}</small>
                            </div>`;
                    });
                } else {
                    html += '<p class="text-muted">Nenhum evento recente registrado</p>';
                }
                
                document.getElementById('recentEvents').innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar eventos recentes:', error);
                document.getElementById('recentEvents').innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar eventos: ${error.message}
                    </div>`;
            }
        }

        // Carregar logs
        async function loadLogs() {
            try {
                toggleLoading('refreshLogs', true);
                
                const lines = document.getElementById('log-lines-count').value;
                document.getElementById('logEntries').innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>`;
                
                const response = await fetch(`/api/logs?lines=${lines}`);
                if (!response.ok) throw new Error('Erro ao carregar logs');
                
                const data = await response.json();
                
                let html = '';
                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => {
                        const logClass = log.includes('ERROR') ? 'log-error' : 
                                        log.includes('WARNING') ? 'log-warning' : 'log-info';
                        html += `<div class="log-entry ${logClass}">${log}</div>`;
                    });
                } else {
                    html = '<p class="text-muted">Nenhum log disponível</p>';
                }
                
                document.getElementById('logEntries').innerHTML = html;
                document.getElementById('logEntries').scrollTop = document.getElementById('logEntries').scrollHeight;
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                document.getElementById('logEntries').innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar logs: ${error.message}
                    </div>`;
            } finally {
                toggleLoading('refreshLogs', false);
            }
        }

        // Inicializar gráficos
        function initCharts() {
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
                    datasets: [{
                        label: 'Atividade de Voz (minutos)',
                        data: [120, 190, 170, 220, 180, 150, 200],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} minutos`;
                                }
                            }
                        }
                    }
                }
            });
            
            const usageCtx = document.getElementById('usageChart').getContext('2d');
            usageChart = new Chart(usageCtx, {
                type: 'bar',
                data: {
                    labels: ['Usuários Ativos', 'Usuários Inativos', 'Usuários Avisados'],
                    datasets: [{
                        label: 'Status de Usuários',
                        data: [65, 12, 8],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(255, 99, 132, 0.2)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar gráficos com dados reais
        async function updateCharts() {
            try {
                const response = await fetch('/api/activity_stats');
                if (!response.ok) throw new Error('Erro ao carregar estatísticas');
                
                const data = await response.json();
                
                if (activityChart && usageChart) {
                    // Atualizar gráfico de atividade (dados simulados)
                    const newData = Array(7).fill().map(() => Math.floor(Math.random() * 200) + 50);
                    activityChart.data.datasets[0].data = newData;
                    activityChart.update();
                    
                    // Atualizar gráfico de uso
                    if (data.total_users > 0) {
                        usageChart.data.datasets[0].data = [
                            data.active_users,
                            data.inactive_users,
                            data.warned_users
                        ];
                        usageChart.update();
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar gráficos:', error);
            }
        }

        // Carregar status do sistema
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) throw new Error('Erro ao carregar status');
                
                const data = await response.json();
                
                // Atualizar nome do bot
                document.getElementById('bot-name').textContent = data.bot_name || 'Inactivity Bot';
                
                // Atualizar status do bot
                const botStatusIcon = document.getElementById('bot-status-icon');
                const botStatusText = document.getElementById('bot-status-text');
                
                if (data.bot_status === 'Operacional') {
                    botStatusIcon.className = 'status-indicator status-operational';
                    botStatusText.textContent = 'Operacional';
                } else {
                    botStatusIcon.className = 'status-indicator status-error';
                    botStatusText.textContent = 'Erro';
                }
                
                // Atualizar contagem de servidores
                document.getElementById('guild-count').textContent = data.guild_count;
                
                // Atualizar uptime
                document.getElementById('uptime').textContent = data.uptime;
                
                // Atualizar status do banco de dados
                const dbStatusBadge = document.getElementById('db-status-badge');
                if (data.db_status.includes('Operacional')) {
                    dbStatusBadge.className = 'badge bg-success';
                    dbStatusBadge.textContent = 'Operacional';
                } else if (data.db_status.includes('Erro')) {
                    dbStatusBadge.className = 'badge bg-danger';
                    dbStatusBadge.textContent = 'Erro';
                } else {
                    dbStatusBadge.className = 'badge bg-warning';
                    dbStatusBadge.textContent = 'Desconhecido';
                }
                
                // Atualizar status das filas
                let queueHtml = '';
                for (const [queue, size] of Object.entries(data.queue_status)) {
                    let badgeClass = 'bg-secondary';
                    if (size > 100) badgeClass = 'bg-danger';
                    else if (size > 50) badgeClass = 'bg-warning';
                    else if (size > 0) badgeClass = 'bg-primary';
                    
                    queueHtml += `<span class="badge ${badgeClass} queue-status-badge">${queue}: ${size}</span>`;
                }
                document.getElementById('queue-status').innerHTML = queueHtml;
            } catch (error) {
                console.error('Erro ao carregar status do sistema:', error);
                showToast('Erro ao carregar status do sistema: ' + error.message, 'error');
            }
        }

        // Salvar configurações
        async function saveConfig() {
            try {
                toggleLoading('save-config', true);
                
                const config = {
                    required_minutes: document.getElementById('required_minutes').value,
                    required_days: document.getElementById('required_days').value,
                    monitoring_period: document.getElementById('monitoring_period').value,
                    kick_after_days: document.getElementById('kick_after_days').value,
                    notification_channel: document.getElementById('notification_channel').value,
                    log_channel: document.getElementById('log_channel').value,
                    absence_channel: document.getElementById('absence_channel').value,
                    timezone: document.getElementById('timezone').value
                };

                const response = await fetch('/api/update_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erro ao salvar configurações');
                }
                
                showToast('Configurações salvas com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                showToast('Erro ao salvar configurações: ' + error.message, 'error');
            } finally {
                toggleLoading('save-config', false);
            }
        }

        // Criar backup
        async function createBackup() {
            try {
                toggleLoading('backup-bot', true);
                
                if (!confirm('Deseja criar um backup do banco de dados agora?')) {
                    return;
                }
                
                const response = await fetch('/api/backup', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erro ao criar backup');
                }
                
                const data = await response.json();
                showToast(data.message || 'Backup criado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showToast('Erro ao criar backup: ' + error.message, 'error');
            } finally {
                toggleLoading('backup-bot', false);
            }
        }

        // Reiniciar bot
        async function restartBot() {
            try {
                if (!confirm('Tem certeza que deseja reiniciar o bot? Isso pode causar uma breve interrupção no serviço.')) {
                    return;
                }
                
                const response = await fetch('/api/restart', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erro ao reiniciar o bot');
                }
                
                const data = await response.json();
                showToast(data.message, 'success');
                
                // Mostrar mensagem de reinicialização
                setTimeout(() => {
                    showToast('O bot está reiniciando...', 'info');
                }, 2000);
            } catch (error) {
                console.error('Erro ao reiniciar o bot:', error);
                showToast('Erro ao reiniciar o bot: ' + error.message, 'error');
            }
        }

        // Exportar relatório
        function exportReport() {
            showToast('Relatório exportado com sucesso! (Funcionalidade simulada)', 'info');
        }

        // Configurar eventos dos botões
        function setupEventListeners() {
            // Whitelist
            document.getElementById('add-user-whitelist').addEventListener('click', () => {
                const userId = document.getElementById('whitelist-user-id').value;
                if (userId) {
                    updateWhitelist('add', 'user', userId);
                } else {
                    showToast('Por favor, insira um ID de usuário válido', 'warning');
                }
            });
            
            document.getElementById('add-role-whitelist').addEventListener('click', () => {
                const roleId = document.getElementById('whitelist-role-id').value;
                if (roleId) {
                    updateWhitelist('add', 'role', roleId);
                } else {
                    showToast('Por favor, insira um ID de cargo válido', 'warning');
                }
            });
            
            // Logs e eventos
            document.getElementById('refreshEvents').addEventListener('click', loadRecentEvents);
            document.getElementById('refreshLogs').addEventListener('click', loadLogs);
            
            // Configurações
            document.getElementById('save-config').addEventListener('click', saveConfig);
            document.getElementById('restart-bot').addEventListener('click', restartBot);
            document.getElementById('backup-bot').addEventListener('click', createBackup);
            document.getElementById('export-report').addEventListener('click', exportReport);
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar dados iniciais
            loadSystemStatus();
            loadGuilds();
            loadWhitelist();
            loadRecentEvents();
            loadLogs();
            loadConfig();
            initCharts();
            setupEventListeners();
            
            // Configurar atualizações periódicas
            refreshIntervals.push(setInterval(loadSystemStatus, 10000)); // 10 segundos
            refreshIntervals.push(setInterval(updateCharts, 30000)); // 30 segundos
            refreshIntervals.push(setInterval(loadRecentEvents, 15000)); // 15 segundos
            refreshIntervals.push(setInterval(loadLogs, 20000)); // 20 segundos
        });

        // Limpar intervalos quando a página é fechada
        window.addEventListener('beforeunload', () => {
            refreshIntervals.forEach(interval => clearInterval(interval));
        });
    </script>
</body>
</html>